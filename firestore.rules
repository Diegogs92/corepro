rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // FUNCIONES AUXILIARES
    // ========================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================================================
    // REGLAS POR COLECCIÓN
    // ========================================================================

    // INVERSORES - Solo lectura para autenticados
    match /inversores/{inversoresId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo admin puede modificar (implementar roles)
    }

    // GASTOS DE INVERSIÓN - Solo lectura para autenticados
    match /gastosInversion/{gastoId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo admin puede modificar
    }

    // SOCIOS - Lectura y escritura para autenticados
    match /socios/{socioId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // EMPLEADOS - Solo lectura para autenticados
    match /empleados/{empleadoId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo admin puede modificar
    }

    // USUARIOS - Lectura y escritura para autenticados
    match /usuarios/{usuarioId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false; // Solo marcar como inactivo
    }

    // CATEGORÍAS DE PRODUCTOS - Lectura para todos
    match /categoriasProductos/{categoriaId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // PRODUCTOS - Lectura para todos, escritura para autenticados
    match /productos/{productoId} {
      allow read: if true;
      allow create, update, delete: if isAuthenticated();

      // Validaciones
      allow update: if isAuthenticated() &&
        request.resource.data.stockActual >= 0 &&
        request.resource.data.precioBase >= 0;
    }

    // VENTAS - Lectura y escritura para autenticados
    match /ventas/{ventaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();

      // Validaciones
      allow create: if request.resource.data.total >= 0 &&
        request.resource.data.fecha != null;
    }

    // ITEMS DE VENTA - Lectura y escritura para autenticados
    match /itemsVenta/{itemId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();

      // Validaciones
      allow create: if request.resource.data.cantidad > 0 &&
        request.resource.data.precioUnitario >= 0;
    }

    // PAGOS - Lectura y escritura para autenticados
    match /pagos/{pagoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;

      // Validaciones
      allow create: if request.resource.data.monto > 0;
    }

    // CATEGORÍAS DE GASTOS - Lectura para autenticados
    match /categoriasGastos/{categoriaId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // GASTOS - Lectura y escritura para autenticados
    match /gastos/{gastoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;

      // Validaciones
      allow create: if request.resource.data.monto >= 0;
    }

    // PAGOS DE SUELDOS - Solo lectura para autenticados
    match /pagosSueldos/{pagoId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo admin puede modificar
    }

    // MOVIMIENTOS DE STOCK - Lectura para autenticados
    match /movimientosStock/{movimientoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false; // No modificar historial
    }

    // COSECHAS - Lectura y escritura para autenticados
    match /cosechas/{cosechaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }

    // MOVIMIENTOS DE CAJA - Lectura para autenticados
    match /movimientosCaja/{movimientoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false; // No modificar historial
    }

    // CULTIVOS - Lectura y escritura para autenticados
    match /cultivos/{cultivoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false; // Soft delete
    }

    // CAMAS - Lectura y escritura para autenticados
    match /camas/{camaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }

    // MACETAS - Lectura y escritura para autenticados
    match /macetas/{macetaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }

    // GENETICAS - Lectura y escritura para autenticados
    match /geneticas/{geneticaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }

    // REGISTROS DE CULTIVO - Lectura para autenticados
    match /registrosCultivo/{registroId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // SECUENCIAS - Contadores internos
    match /secuencias/{secuenciaId} {
      allow read, write: if isAuthenticated();
    }
  }
}
